
#### 8.3.2.3 哈希锁定
&emsp;&emsp;哈希锁定的算法思想本质上是使用哈希锁定智能合约来安全地进行零确认交易，闪电网络是哈希锁定技术综合的典型应用，目的是安全地实现链下可扩展的小型即时交易，提升链下的交易处理能力。它有两种交易合约：到期序列可撤销合约（Revocable Sequence Maturity Contract，RSMC）以及哈希时间锁合约（Hashed Timeloch Contract，HTLC）。HTLC同时使用了哈希锁定和时间锁定，使得用户进行的零确认交易与在比特币网络上一样安全。

&emsp;&emsp;接下来简单介绍RSMC和HTLC的工作原理

**RSMC工作原理**

1. 交易双方将协议的资金按比例分配后放入资金池中，并在互相签署合约后，将总资金广播计入主链区块中；
2. 交易双方在不超过资金池总金额的前提下，在主链下进行交易，交易次数无限制；
3. 每一次交易都必须签署全新的合约，合约仅仅在双方的交易通道中流转，并未广播计入主链区块；
4. 当最后双方协议不再进行新交易，准备取回各自资金时，将由其中一方发起广播请求；
5. 如果其中一方发觉交易结果不正确，可以根据双方交易合约中的前置协议条件，在有效时间内提出真假合约验证请求；
6. 广播虚假交易合约一经证实，作假方在资金池内所有的自持资金将会作为赔偿支付给另一方。

**HTLC工作原理**

1. 假设A想要发1BTC给C，但是A和C之间没有链下通道。然而，双方都与一个节点B有一条链下通道（这条通道必须是支持HTLC并且余额足够的）；
2. 收款方C先设定一条谜题和答案，实际上就是自己生成一个Y，并且用哈希算出H(Y)=X，并把哈希值Y发给A；
3. A与B根据给的Y，协商出一个链下的HTLC，如果B能在2天内给出Y的原像，即X，则可以获得A的1.1BTC，否则，这个合约失效；
4. B再与C协商出一个链下的HTLC，如果C能在一天内给出Y的原像，即X，则可以获得C的1BTC，否则，这个合约失效；
5. 当两个合约都建立之后，C给出X，并从B那里获得1个比特币，然后，获得X的B给出X，从A那里获得1.1个比特币。这里，0.1个比特币是B作为中介的费用。

**哈希锁定的简单流程**

1. A生成随机数s，并计算哈希值h=hash(s)，将h发送给B；
2. A生成锁定合约，设定解锁条件：在时间T内B猜出随机数s，则取走合约设置的资产，并将s公开广播并记录在区块链上，否则交易退还到原账户中；
3. B在链B中部署智能合约，如果有谁能在t<T时间内提供一个随机数 s，使得h=hash(s)，则取走锁定的资产，否则交易回退；
（这里A用h锁住合约，同时B也有相同的h锁住自己的资产。这样A和B都有相同的锁h，但只有A有钥匙s）
4. A调用B部署的智能合约提供正确的s，取走资产，这样就留下s；则B得知s，在剩余的时间内，B可以从容兑现A的HTLC的1BTC。
