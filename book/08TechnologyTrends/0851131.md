### 8.5.1 区块链与联邦学习
&emsp;&emsp;在传统联邦学习中，每个设备可以交换其本地模型更新，即学习模型的权重和梯度参数比原始数据模型更加注重隐私。global model:通过中央服务器聚集所有局部模型更新并取总体平均值，产生全局模型更新。local model:每个设备下载全局模型更新，并计算其下一个局部更新直到全局模型训练完成。中心化的联邦学习缺点明显，包括：

1. 任何参数传递模型更新都需要中央协调，易受集中服务器故障影响，由此而产生不准确的全局模型更新扭曲了局部模型更新，可能导致整个训练崩溃。这就需要分布式的联邦学习体系结构；
2. 不信任的参与者出于队隐私和财务方面的考虑，恶意服务器或参与者可能会破坏训练的正确性，例如不正确的梯度收集或参数更新。未引入补偿机制易导致参与方数据样本提供不公平的状况，以及不诚实的参与者伪造数据样本。为了解决私有交换和奖励机制的问题，需利用一个高效公平的激励机制。

&emsp;&emsp;针对传统联邦学习依赖单一的中央服务器，容易受到服务器故障的影响；没有合适的奖励机制来刺激用户提供数据训练和上传模型参数问题，引入一种基于区块链的去中心化的价值驱动激励机制（后称区块链联邦学习，简称Block FL），它激励不信任方参与隐私保护学习，正确地共享梯度和更新参数，最终实现双赢的迭代学习。区块链联邦学习要实现以下功能：

1. 移动设备的本地学习模型更新通过利用区块链来交换和验证，本地数据样本归每个设备所有交换时对其他设备保密原始数据样本；
2. 无中央协调通过交换本地数据来训练每个设备的本地模型，本地设备的奖励系统（具有大量数据样本的设备对全局模型训练更大，同时消耗更多的计算能力和时间）。

#### 8.5.1.1 区块链实现联邦学习去中心化及应用
&emsp;&emsp;欲了解区块链去中心化原理需掌握区块链联邦学习全局工作流程，区块链联邦学习的逻辑结构由移动设备和矿工组成，矿工可以是随机选择的设备，也可以是独立的节点。其具体流程如下：
1. Block FL中每个设备计算本地模型更新并将其上传到区块链网络中与其关联的矿工，同时作为回报，从矿工接受与其数据样本数量成比例的数据奖励；
2. 矿工交叉验证所有本地模型更新，然后运行工作证明算法（pow）；
3. 一旦矿工完成pow，它生成一个块，在该块中记录已验证的本地更新，并从区块链网络中接收采矿奖励；
4. 存储聚合本地模型更新的生成块被添加到区块链，也称为分布式账本，并由设备下载。每个设备从最新的块计算全局模型更新，这是下一个本地模型更新的输入。

&emsp;&emsp;区块链在Block FL中发挥去中心化作用：在BlockFL的区块链网络中，区块及其矿工的验证旨在通过分布式帐本交换本地模型更新。账本中的每个块都分为区块头和区块体两部分。在区块链结构中,区块体部分包含一个经过验证的交易列表。在BlockFL中，区块体存储了设备的本地模型更新，按照区块链的结构，区块头部分包含前一个块的指针信息，块生成率λ和pow算法的输出值（nonce），为了存储所有设备的本地模型更新，每个块大小随头部和模型更新大小，每一个矿工都有一个候选块，该块按照到达的顺序提供了来自其关联设备或者其他矿工的本地模型更新。填充过程一直持续到它到达块的大小或者每个周期开始测量的最大等待时间。简单起见，假设最大等待时间足够长，以便每块总是被所有设备的本地模型更新填满。之后，按照pow算法 ，矿工继续生成随机数，直到该随机数nonce变得小于目标值。一旦矿工M1成功地找到这个随机数，它的候选块就被允许生成为新块（可以通过调整pow难度来控制块生成速率λ，pow目标值越低，λ越小）。随后将生成的块传播给所有其他矿工，以便同步他们所有的分布式帐本。为此，正如在区块链中所做的那样，所有接收生成块的矿工都被迫停止他们的pow操作，并将生成块添加到他们的本地账本中。如果另一个矿工M2在第一个生成的块的传播延迟内成功地生成了它的区块，那么一些矿工可能会错误地将第二个生成的块添加到它们的本地账本中，这被称为forking（分叉）。在BlockFL中，forking使一些设备将不正确的全局模型更新应用到它们的下一个局部模型更新。

&emsp;&emsp;由于区块链联邦学全局模型更新是在每个设备本地计算的，从上述更新流程可得出，矿工/设备在全局模型更新中的故障不会影响其他设备的局部全局模型更新，实现去中心化参数传递与模型更新，从而确保整体训练的健壮性。区块链联邦学习能够实现：
1. 移动设备的本地学习模型更新通过利用区块链来交换和验证；
2. 无中央协调通过交换本地数据来训练每个设备的本地模型。

&emsp;&emsp;自动驾驶中的应用：我国的城市内道路场景复杂多样，给无人驾驶带来了严峻的挑战。其中物流等行业每年需要大量的司机长距离行驶在高速公路上，愿意从事这一行业的年轻人越来越少。同时，高发的道路安全事故也给这个行业笼罩上一层阴影。去中心化联邦学习解决方案效果：利用不同车辆的数据,同时保护数据隐私,减少通信带宽,通过联邦学习建模,基于nvidia-Jetson RC实验车，联邦学习在避障、道路规划等项目上性能显著优于单车的学习。其中在避障子项上，基于联邦学习的实验车，避障性能优于普通实验车48%以上。

#### 8.5.1.2 区块链解决联邦学习激励不足及不公平问题
&emsp;&emsp;首先介绍传统联邦学习在激励方面的缺陷：没有合适的奖励机制来刺激用户提供数据训练和上传模型参数。联邦学习需要大量的数据样本，并且需要与其他设备进行数据样本交换，在没有提供与样本数量成比例的适当补偿的情况下，会造成设备数据样本提供不公平的局面，某些设备不太愿意与拥有少量数据样本的其他设备联合。另由于补偿机制带来的副作用，一些不诚实的设备伪造具有比实际样本大小更多的数据样本，从而在联邦学习产生不准确的全局模型更新。

&emsp;&emsp;除了本地模型更新交换操作外，区块链网络还对设备的数据样本提供奖励，对矿工的验证过程提供奖励，分别称为数据奖励和采矿奖励。设备Di的数据奖励从其关联的矿工接收，其数量与数据样本大小Ni成正比。当矿工Mj生成一个块时，它的采矿奖励由区块链网络获得，就像传统的区块链结构一样。采矿奖励的数量与其所有关联设备的数据样本总量成正比，这促使矿工收集更多的本地模型更新，同时补偿他们的数据奖励支出，作为奖励系统的一个副作用，一些不诚实的设备可能通过夸大用于本地模型数据的实际样本大小或者在不进行本地学习计算的情况下生成任意的本地模型更新来欺骗矿工。矿工在将本地模型更新存储在其候选块中之前，会验证真实的本地更新。验证是通过将样本大小Ni 与其相应的本地计算时间Tloacl进行比较来执行的，这被认为是真实的，例如Intel的SGX技术下，经过时间的证明是可行的。区块链网络允许交换设备的本地模型更新，同时能够验证和提供他们相应的奖励。
