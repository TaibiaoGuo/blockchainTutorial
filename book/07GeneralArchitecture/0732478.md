### 7.3.2.4 智能合约
#### 智能合约介绍
&emsp;&emsp;以太坊是最早提出做智能合约的平台。由于以太坊区块链被普遍接受，因此多数区块链的智能合约采取与以太坊相似的设计。以太坊的智能合约并非现实中常见的合同，而是存在区块链上，可以被触发执行的一段程序代码，这些代码实现了某种预定的规则，是存在于以太坊执行环境中的“自治代理”。以太坊的智能合约图如图1所示。
![0732478.jpg](./figures/0732478(2).jpg)

&emsp;&emsp;以太坊的智能合约设计很简明：
1. 任何人都可以在以太坊区块链上开发智能合约，这些智能合约的代码是存在于以太坊的账户中的，这类存有代码的账户叫合约账户。对应地，由密钥控制的账户可称为外部账户。以太坊的智能合约程序，是在以太坊虚拟机（Ethereum Virtual Machine,EVM）上运行的；
2. 合约账户不能自己启动并运行。要运行一个智能合约，需要由外部账户对合约账户发起交易，从而启动其中的代码的执行。

&emsp;&emsp;以太坊和比特币的一个重大不同是，前者提供了图灵完备的编程语言（Solidity）和相应的运行环境（EVM）。所谓图灵完备，指的是这个脚本编程语言可以运行所有可能的计算，而比特币的UTXO模型和脚本只能运行部分计算。

#### 智能合约的部署
&emsp;&emsp;如下图，合约的部署跟发送一笔交易是一样的操作，调用transaction函数，from为发布者的地址，to为0，data为合约的evm操作码。在矿工打包的时候会生成智能合约地址。智能合约地址的生成是由创建者的账号和发送的交易数作为随机数输入，通过Kecca-256加密算法重新创建一个地址作为账号。也就是说最后合约地址对应合约的代码会保存在区块链数据库。调用者只需要有合约地址和ABI文件就可以调用合约的代码。
![0732478.jpg](./figures/0732478(3).jpg)

#### 智能合约的调用
&emsp;&emsp;要调用合约需要合约的地址和合约的方法。智能合约是部署在区块链的代码，区块链本身不能执行代码，代码的执行是在本地的EVM中，实际上，部署在区块链上代码是能够在本地产生原智能合约代码的代码，可以理解区块链为一个数据库，而客户端从数据库中读取了存储的运行代码，并在本地运行后，将结果写入到了区块链这个数据库中。调用流程图如下图：
![0732478.jpg](./figures/0732478(4).jpg)

#### 智能合约用途
&emsp;&emsp;以太坊的智能合约被广泛应用的一个用途是创建通证，通证对应的多是以太坊区块链之外的资产。图2是一个简明的图示，这是从Komhar咨询公司的一个图示重绘而来的。图示是一个典型的ERC20通证发行过程：一个项目通过智能合约创建通证，这个通证是实体资产或线上资产的价值表示物。投资者（用户）发起交易，向智能合约转入以太币（ETH），智能合约自动运转，在满足一定规则后，它向投资者账户转入相应数量的通证。
![0732478.jpg](./figures/0732478(1).jpg)