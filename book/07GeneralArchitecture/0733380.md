#### 7.3.3.3 智能合约
&emsp;&emsp;链上代码，简称链码，又称智能合约。一般是指由开发人员使用Java语言（也支持Go等语言）编写的应用程序代码，提供分布式账本的状态处理逻辑。链码被部署在Fabric的网络节点中，能够独立运行在具有安全特性的受保护的Docker容器中，以gRPC协议与相应的Peer节点进行通信，以操作（初始化或管理）分布式账本中的数据。可以根据不同的需求开发出不同的复杂的应用。作为受信任的分布式应用程序，从区块链中获得信任，在节点中达成基本共识。是区块链应用的业务逻辑。

&emsp;&emsp;有三个关键点适用于智能合约，尤其是应用于平台时：

1. 多个智能合约在网络中同时运行；
2. 智能合约可以动态部署；
3. 应用代码应视为不被信任的，甚至可能是恶意的。

&emsp;&emsp;大多数现有的具有智能合约能力的区块链平台遵循顺序执行架构，其中共识协议：

1. 验证并将交易排序，然后将它们传播到所有的节点；
2. 每个节点按顺序执行交易。

&emsp;&emsp;几乎所有现有的区块链系统都可以找到顺序执行架构，从非许可平台，如Ethereum（基于PoW共识）到许可平台，如Tendermint、Chain和Quorum。采用顺序执行架构的区块链执行智能合约的结果一定是确定的，否则，可能永远不会达成共识。为解决非确定性问题，许多平台要求智能合约以非标准或特定领域的语言（例如Solidity）编写，以便消除非确定性操作。这阻碍了平台的广泛采用，因为它要求开发人员学习新语言来编写智能合约，而且可能会编写错误的程序。此外，由于所有节点都按顺序执行所有交易，性能和规模被限制。事实上系统要求智能合约代码要在每个节点上都执行，这就需要采取复杂措施来保护整个系统免受恶意合约的影响，以确保整个系统的弹性。

&emsp;&emsp;Fabric为交易引入了一种新的架构，称之为execute-order-validate。它通过将交易流分为三个步骤来解决order-execute模型面临的弹性、灵活性、可伸缩性、性能和机密性挑战：

1. execute: 执行交易并检查其正确性，从而认可 (endorsing) 该交易；
2. order: 通过 (可插拔) 共识协议 order 交易；
3. validate: 在将交易提交到账本之前，根据特定于应用程序的背书策略 (endorsement policy) 验证交易。

&emsp;&emsp;这种设计与order-execute范式完全不同，Fabric在达成交易的最终协议之前执行交易。在Fabric中，特定于应用程序的背书策略指定需要其中的哪些对端节点保证给定智能合约的正确执行。因此，每笔交易只需要由满足交易认可策略所需的对端节点的子集执行 (认可) 即可。这允许并行执行，从而提高了系统的整体性能和规模。第一阶段还消除了任何不确定性，因为不一致的结果可以在Order前滤除。

&emsp;&emsp;因为消除了不确定性，所以Fabric是第一个启用通用编程语言使用的区块链技术。在 1.4.3 版本中，可以使用 Go、Node.js、Java 编写智能合约。
