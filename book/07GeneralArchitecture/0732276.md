# 7.3.2.2 账户
&emsp;&emsp;以太坊中的账户分为两种，分别为外部拥有账户（EOA）和合约账户。外部拥有账户具有以下特性：有一个以太币余额、可以发送交易（以太币转账或者激活合约代码）、通过私钥控制、没有相关联的代码。而合约账户拥有以下特性：有一个以太币余额、有相关联的代码、代码执行是通过交易或者其他合约发送的call来激活、当被执行时，运行在随机复杂度 （图灵完备性）只能操作其拥有的特定储存，例如可以call其他合约。

&emsp;&emsp;所有以太坊区块链上的行动都是由各账户发送的交易激活。每次一个合约账户收到一个交易，交易自带的参数都会成为代码的输入值运行。合约代码会被以太坊虚拟机（EVM）在每一个参与网络的节点上运行，以作为它们新区块的验证。
### 账户优点
1. 可以节省大量空间：不将UTXOs分开存储，而是合为一个账户，每
个交易只需要一个输入、一个签名并产生一个输出；
2. 更好的可替代性：货币本质上都是同质化、可替代的；
3. 更加简单：更容易编码和理解，特别是设计复杂脚本的时候；
4. 便于维护持久轻节点：只要沿着特定方向扫描状态树，轻节点可以很
容易地随时访问账户相关的所有数据。
### 账户状态
&emsp;&emsp;无论账户的类型如何，账户状态由四个部分组成：
1. nonce：如果账户是一个外部拥有账户，nonce代表从此账户地址发送的交易序号。如果账户是一个合约账户，nonce代表此账户创建的合约序号；
2. balance：此地址拥有Wei的数量。1Ether=10^18Wei；
3. storageRoot：Merkle Patricia树的根节点Hash值。Merkle tree会将此账户存储内容的Hash值进行编码，默认是空值；
4. codeHash：此账户EVM代码的hash值。对于合约账户，就是被Hash的代码并作为codeHash保存。对于外部拥有账户，codeHash域是一个空字符串的Hash值。
### 全局状态
&emsp;&emsp;全局状态由帐户地址和帐户状态之间的映射组成。这个映射存储在一个称为Merkle Patricia树的数据结构中。而Merkle Tree是由一组节点组成的一种二叉树，这些节点包括：
1. 包含底层数据的树底部的大量叶子节点；
2. 一组中间节点，其中每个节点是其两个子节点的散列；
3. 单个根节点，也是由其两个子节点的Hash形成的，代表树的顶部。

&emsp;&emsp;树底部的数据是通过将我们想要存储的数据分成chunks块来生成的，然后将chunks分成buckets，然后取每个buckets的hash值并重复相同的过程，直到剩余的hash总数变为只有一个根hash。树需要有一个存储在里面的每个值的键（key）。从树的根节点开始，关键字应该告知你哪个子节点要获取相应的值，该值存储在叶节点中。在以太坊的情况下，状态树的键/值映射位于地址及其相关帐户之间，包括每个帐户的balance，nonce，codeHash和storageRoot（其中storageRoot本身就是树）。同样的树结构也用来存储交易和收据。更具体的说，每个块都有一个头(header)，保存了三个不同Merkle trie结构的根节点的Hash，包括：状态树、交易树、收据树。

&emsp;&emsp;在Merkle tries中有效地存储所有信息的能力在以太坊我们称之为“轻客户端”或“轻节点”。一般来说，有两种类型的节点：全节点和轻节点。全节点通过下载整条链来进行同步，从创世纪块到当前块，执行包含在其中的所有交易。通常情况下，矿工存储全节点，因为他们在挖矿过程中需要全节点。也可以在不执行每个交易的情况下下载全节点。无论如何，一个全节点都包含整个链。但是，除非一个节点需要执行每个交易或者轻松查询历史数据，否则实际上不需要存储整个链。这是轻节点概念的来源。轻型节点不是下载并存储完整链并执行所有交易，而是仅从起始块到当前块的头，而不执行任何交易或检索任何关联的状态。由于轻节点可以访问块的头，而头中包含了3个tries的Hash，所有轻节点依然可以很容易生成和接收关于交易、事件、余额等可验证的答案。这样做的原因是因为Merkle tree中的hash向上传播如果恶意用户试图将假交易交换到Merkle tree的底部，这种更改将导致上面节点的散列发生变化，从而将改变以上的节点的散列，直到它最终改变树的根。

&emsp;&emsp;任何想要验证数据的节点都可以使用“Merkle证明”来实现。Merkle证明包括：
1. 要验证的数据块和散列；
2. 树的根hash；
3. 一个“分支”（从 chunk到根这个路径上所有的hash值）。

&emsp;&emsp;任何读取证明的人都可以验证该分支的hash在树中一直保持一致，因此给定的块实际上是在树中的那个位置。

&emsp;&emsp;总之，使用Merkle Patricia树的好处是，这个结构的根节点在密码上依赖于存储在树中的数据，所以根节点的散列可以用作这个数据的安全身份。由于块头包含状态，交易和收据树的根hash，所以任何节点都可以验证以太坊状态的一小部分，而不需要存储整个状态，这个状态的大小可能是无限的。

### 公钥和私钥
&emsp;&emsp;每个账户都会由一对私钥和公钥组成。每个账户都有一个地址，而这个地址，就是交易时用的地址。A往B转100ETH，其实就是B的地址转100ETH。这个地址，就像我们的银行卡号一样，可以公开的随便告诉别人。

&emsp;&emsp;私钥，公钥和地址的关系：
![0732276.jpg](./figures/0732276(1).jpg)
&emsp;&emsp;私钥经过一种哈希算法(椭圆曲线算法ECDSA-secp256k1)计算生成公钥，然后取公钥的最后160位二进制(通常表现为40位的16进制字符串)形成了地址。其中，公钥和地址都是可以公布的，而私钥一旦泄露，账户中的资产就会面临丢失的风险。所以，私钥的保存非常重要。

&emsp;&emsp;在比特币世界中，私钥的保存方式是：把一串很长的私钥用你能想到最可靠的办法保存起来；私钥的保存，甚至催生一条产业链和一批创业公司，比方说电子硬件钱包，专门帮你保存私钥到一个便携的设备中。

&emsp;&emsp;在以太坊的世界中，私钥的表现形式和保存方式又不一样了：它由一个密码和一个keyfile组成。这个密码就是我们通常在互联网上注册账户时用的密码。而keyfile则是一个明文的JSON格式文件，里面保存的是私钥的加密信息。以太坊的客户端，可以通过密码和keyfile，解密出私钥。
![0732276.jpg](./figures/0732276(2).jpg)
### 比特币和以太坊的对比
|  | BitCoin | Ethereum
-- | -- | --
设计定位 | 现金系统 | 去中心化应用平台
数据组成 | 交易列表(账本) | 交易和庄户状态
交易对象 | UTXO | Accounts
代码控制 | 脚本 | 智能合约